---
title: "Less business than usual"
author: "Markus Konrad"
date: "March 31, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r, warning=FALSE, message=FALSE}
source('dataprep.R')
source('plotting.R')

pop <- load_pop_data()
collection_time <- range_collection_time(pop)
pop <- select(pop, -utc_date, -utc_hour)

pop_approx <- group_by(pop, local_day, place_id) %>%
    do(interpolate_per_place(.)) %>% ungroup()

pop_noparks <- filter(pop, category != 'parks')
pop_noparks_approx <- filter(pop_approx, category != 'parks')

popeur <- filter(pop, region == 'Europe') %>% select(-region)
popeur_approx <- filter(pop_approx, region == 'Europe') %>% select(-region)
popeur_noparks <- filter(popeur, category != 'parks')
popeur_noparks_approx <- filter(popeur_approx, category != 'parks')
```

- motivation: effect of soc. dist. measures on public mobility
- explain data source and motivation: Google Places API / popularity
- data collection (search queries, categories) and time frame
- caution / limits (due to costly API queries) / focus on Europe and cities / city population only!
- categories are mutually exclusive

## Europe


- daily mean over time

```{r}
ts_country_daily_means <- group_by(popeur, local_day, country) %>% group_means_ci(pop_diff) %>% ungroup()
ts_daily_means <- group_by(ts_country_daily_means, local_day) %>%
    group_means_ci(mean_pop_diff)

plot_ts_means_ribbon(ts_daily_means, local_day, mean_mean_pop_diff, lwr_mean_pop_diff, upr_mean_pop_diff,
                     'Mean daily popularity difference over time in Europe', collection_time)

```


- mean per category

```{r}
country_cat_means <- group_by(popeur, country, category) %>% group_means_ci(pop_diff)
cat_means <- group_by(country_cat_means, category) %>% group_means_ci(mean_pop_diff)

plot_means_errorbars(cat_means, category, mean_mean_pop_diff, lwr_mean_pop_diff, upr_mean_pop_diff,
                     'Differences in popularity score per category in Europe', collection_time)
```


- daily mean over time per categ.

```{r}
ts_country_cat_daily_means <- group_by(popeur, local_day, category, country) %>% group_means_ci(pop_diff) %>% ungroup()
ts_daily_cat_means <- group_by(ts_country_cat_daily_means, local_day, category) %>%
    group_means_ci(mean_pop_diff)

plot_ts_cat_means_ribbon(ts_daily_cat_means, local_day, mean_mean_pop_diff,
                         lwr_mean_pop_diff, upr_mean_pop_diff, category,
                         'Mean daily popularity difference per category over time in Europe',
                         collection_time)

```

- hourly means to reveal daily patterns

```{r, message=FALSE, warning=FALSE}
popeur_approx_firstweek <- filter(popeur_approx, local_day >= '2020-03-23', local_day <= '2020-03-29')
ts_country_means <- group_by(popeur_approx_firstweek, local_time, country) %>% group_means_ci(pop_diff) %>% ungroup()

ts_means <- group_by(ts_country_means, local_time) %>% group_means_ci(mean_pop_diff) 
ts_means <- low_obs_to_NA(ts_means, n_mean_pop_diff, 5, mean_mean_pop_diff, lwr_mean_pop_diff, upr_mean_pop_diff)

plot_ts_means_ribbon(ts_means, local_time, mean_mean_pop_diff, lwr_mean_pop_diff, upr_mean_pop_diff,
                     'Mean popularity difference over time in Europe', collection_time)
```


- daily patterns
- daily patterns w/o parks
- daily patterns per categ.

## Selected countries world-wide

- first: China
- bad development: Italy, Spain, USA
- different approach in Europe: Sweden
- good handling of crisis? South Korea, Taiwan

## Selected cities?

- NY, Bergamo, Wuhan

## Selected places?

## Conclusion

- first observations; further research needed to better understand patterns
- announce updates for next weeks/months
- interactive dashboard?
- link to GH repo

